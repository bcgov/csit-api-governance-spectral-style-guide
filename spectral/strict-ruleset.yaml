# Title: Strict OpenAPI Style Guide
# 
extends: ./basic-ruleset.yaml

functions:
  - path-segments-no-verbs-blacklist
  - path-segments-no-verbs-probable

rules:

  # Section: Basic Warnings elevated to Errors

  # OpenAPI object info description must be present and non-empty string.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  info-description: error 
  # No injecting eval() JavaScript statements
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  no-eval-in-markdown: error 
  # No injecting script tags
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  no-script-tags-in-markdown: error 
  # OpenAPI object should have alphabetical tags. 
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  openapi-tags-alphabetical: warn
  # OpenAPI object must not have duplicated tag names (identifiers).
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  openapi-tags-uniqueness: error
  # Operation must have a description
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  operation-description: error 
  # Operation must have an operationId
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  operation-operationId: error 
  # Operation must have at least one 2xx or 3xx response.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  operation-success-response: error 
  # Keep trailing slashes off of paths, as it can causes ambiguity.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  path-keys-no-trailing-slash: error
  # Schemas with type: array, require a sibling items field.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  array-items: error
  # A callback should not be defined within another callback.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  oas3-callbacks-in-callbacks: error
  # Server URL should not point to example.com.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  oas3-server-not-example.com: error
  # Server URL should not have a trailing slash.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  oas3-server-trailing-slash: error
  # This rule ensures that server variables defined in OpenAPI Specification 3 (OAS3) and 3.1 are valid, not unused, and result in a valid URL. 
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  oas3-server-variables: error
  # Examples must be valid against their defined schema. This rule is applied to Media Type objects.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  oas3-valid-media-example: error
  # Examples must be valid against their defined schema. This rule is applied to Schema objects.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  oas3-valid-schema-example: error
  # Callbacks should not be defined in a webhook.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  oas3_1-callbacks-in-webhook: error
  # Servers should not be defined in a webhook.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  oas3_1-servers-in-webhook: error
  # operationId: camelCase
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  operation-id-camel-case: error
  # Path segments: kebab-case (lowercase with hyphens)
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  path-segments-kebab-case: error
  # Path parameters: camelCase
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  path-param-camel-case: error
  # Query parameters: camelCase
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  query-param-camel-case: error
  # Schema properties (JSON payload fields): camelCase
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  schema-property-camel-case: error
  # Schema properties: No empty string property names
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  no-empty-property-names: error
  # Every operation must have a summary (short one-line overview)
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  operation-summary: error
  # Parameter objects should have a description.
  # See official [Basic Style Guide](https://github.com/bcgov/csit-api-governance-spectral-style-guide/blob/main/STYLE_GUIDE.md)
  oas3-parameter-description: error  

  # Section: Required Content

  # Enforce OpenAPI 3.x only (no Swagger 2.0)
  # OpenAPI 3.x documents use a top-level "openapi" key with a value like "3.0.3" or "3.1.0".
  # Swagger 2.0 documents use a top-level "swagger" key (usually "2.0").
  # This rule triggers an error if the "swagger" key is present, effectively blocking all Swagger 2.0 specs.
  #
  # Valid example:
  # ```yaml
  # openapi: 3.0.3
  # info:
  #   title: My API
  #   version: 1.0.0
  # paths: {}
  # ```
  #
  # Invalid example:
  # ```yaml
  # swagger: '2.0'
  # info:
  #   title: My API
  #   version: 1.0.0
  # paths: {}
  # ```
  require-openapi-3:
    description: Document must use OpenAPI 3.x (or newer). Swagger 2.0 is not allowed.
    message: "Swagger 2.0 detected (uses 'swagger' key). Use 'openapi: 3.x.x' instead."
    severity: error
    given: $
    then:
      function: falsy
      field: swagger

  # Strict enforcement: known verb anti-patterns → hard error
  # Common verbs that should never appear in path segments are treated as errors.
  # Valid example:
  # ```yaml
  # paths:
  #   /users:
  #     post: ...
  #   /users/{id}:
  #     put: ...
  # ```
  # Invalid example:
  # ```yaml
  # paths:
  #   /createUser:
  #     post: ...
  #   /updateProfile/{id}:
  #     put: ...
  # ```
  path-segments-no-verbs-blacklist:
    description: Path segments must not contain blacklisted verbs (e.g., create, update, validate)
    message: "{{error}}"
    severity: error
    given: $.paths
    then:
      field: "@key"
      function: path-segments-no-verbs-blacklist

  # Section: Recommended Content

  # OpenAPI object should have non-empty tags array.
  # Ensures the root `tags` array is present and contains at least one tag.
  # This helps documentation tools group operations effectively.
  #
  # Valid example:
  # ```yaml
  # openapi: 3.0.3
  # info:
  #   title: Example API
  #   version: 1.0.0
  # tags:
  #   - name: users
  #     description: Operations about users
  # paths: {}
  # ```
  #
  # Invalid example:
  # ```yaml
  # openapi: 3.0.3
  # info:
  #   title: Example API
  #   version: 1.0.0
  # # Missing tags entirely or empty array
  # tags: []
  # paths: {}
  # ```
  # See: [Spectral OpenAPI Rules](https://docs.stoplight.io/docs/spectral/4dec24461f3af-open-api-rules)
  openapi-tags: warn 

  # Use just one tag for an operation
  # Each operation should have exactly one tag (or up to 3 in some versions) to avoid ambiguity in documentation grouping.
  #
  # Valid example:
  # ```yaml
  # paths:
  #   /users:
  #     get:
  #       tags:
  #         - users
  #       summary: List users
  # ```
  #
  # Invalid example:
  # ```yaml
  # paths:
  #   /users:
  #     get:
  #       tags:
  #         - users
  #         - admin
  #         - reports
  #       summary: List users
  # ```
  # See: [Spectral OpenAPI Rules](https://docs.stoplight.io/docs/spectral/4dec24461f3af-open-api-rules)
  operation-singular-tag: warn 

  # Operation should have non-empty tags array.
  # Every operation must define at least one tag for proper grouping in generated documentation.
  #
  # Valid example:
  # ```yaml
  # paths:
  #   /users:
  #     get:
  #       tags:
  #         - users
  #       summary: List users
  # ```
  #
  # Invalid example:
  # ```yaml
  # paths:
  #   /users:
  #     get:
  #       # Missing tags or empty array
  #       tags: []
  #       summary: List users
  # ```
  # See: [Spectral OpenAPI Rules](https://docs.stoplight.io/docs/spectral/4dec24461f3af-open-api-rules)
  operation-tag-defined: warn 

  # Operation tags should be defined in global tags.
  # All tags used in operations must be declared in the root `tags` array for consistency and richer descriptions.
  #
  # Valid example:
  # ```yaml
  # tags:
  #   - name: users
  #     description: User-related endpoints
  # paths:
  #   /users:
  #     get:
  #       tags:
  #         - users
  # ```
  #
  # Invalid example:
  # ```yaml
  # # Missing global declaration of 'users'
  # paths:
  #   /users:
  #     get:
  #       tags:
  #         - users
  # ```
  # See: [Spectral OpenAPI Rules](https://docs.stoplight.io/docs/spectral/4dec24461f3af-open-api-rules)
  operation-tags: warn     

  # Softer guidance: probable verbs detected by NLP → warning only
  # Uses heuristic/NLP analysis to catch less obvious verbs or verb forms.
  # Already blacklisted verbs are skipped to avoid duplicate messages.
  # Allows common exceptions (e.g., "file" in /uploadFile) and explicitly disallows others.
  # Valid example:
  # ```yaml
  # paths:
  #   /uploadFile:
  #     post: ...
  #   /reports/export:
  #     get: ...
  # ```
  # Invalid example:
  # ```yaml
  # paths:
  #   /importData:
  #     post: ...
  #   /generateReport:
  #     get: ...
  # ```
  path-segments-no-verbs-probable:
    description: Path segments should preferably be nouns (NLP heuristic, excludes blacklisted verbs)
    message: "{{error}}"
    severity: warn
    given: $.paths
    then:
      field: "@key"
      function: path-segments-no-verbs-probable
      functionOptions:
        skipBlacklisted: true
        allowed:
          - file
        disallowed:
          - import
          - export